<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Dashboard</title>
    <script>
        (() => {
            const currentUsers = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUsers && currentUsers != null) {
                if (currentUsers.roleId == "2") {
                }
                else {
                    alert("You are not allowed in this page")
                    window.location = 'login.html';
                }
            }
            else {
                alert("You are not allower to view this page")
                window.location = "login.html"
            }
        })();

    </script>
</head>

<body>
    <h1 class="banner">Recruiters Dairy</h1>
    <hr>
    <div id="divButtons" style="display: inline; margin-right: 40px;">
        <input id="todayRadioBtn" type="radio" value="Today" name="datesGroup">:Today
        <input id="YesterdayRadioBtn" type="radio" value="Yesterday" name="datesGroup">:Yesterday

    </div>
    <input type="date" onchange="selectedDate()" id="calenderId1"><br><br>
    <input type="date" id="calenderId2">
    <input type="date" id="calenderId3">
    <button id="btnRangeOfDatesId">Range Of Date</button>

    <div id="divJobs">
    </div>
</body>
<script>

    function newJobs(jobs) {
        if (!jobs) {
            jobs = JSON.parse(localStorage.getItem('jobs'));
        }
        let currentUser = JSON.parse(localStorage.getItem("currentUser"));
        let divJobs = document.getElementById('divJobs');
        if (!jobs || !jobs.length) {
            const divResult = document.createElement("div");
            divResult.innerText = "NO Results Found";
            divJobs.appendChild(divResult);
            return;
        }

        const table = document.createElement('table');
        table.setAttribute("border", "2");

        const trh1 = document.createElement('tr');
        const tdh1 = document.createElement('td')
        tableHeader1 = document.createElement('th4');
        
        tableHeader1.innerText = 'Name Of The Recruiter';
        tdh1.appendChild(tableHeader1);
        trh1.appendChild(tdh1);
        tableHeader1.setAttribute("style", "padding:12px");

        tableHeader2 = document.createElement('th4');
        tableHeader2.innerText = 'No of Jobs';
        const tdh2 = document.createElement('td');
        tdh2.appendChild(tableHeader2);
        trh1.appendChild(tdh2);
        tableHeader2.setAttribute("style", "padding:12px");

        tableHeader3 = document.createElement('th4');
        tableHeader3.innerText = 'view';
        const tdh3 = document.createElement('td');
        tdh3.appendChild(tableHeader3);
        trh1.appendChild(tdh3);
        tableHeader3.setAttribute("style", "padding:12px");

        table.appendChild(trh1);

        const tablebody = document.createElement('tbody');
        let noOfJobs = 0;
        let jobCreatedBy;
        let nameOfRecruiter;
        var teamLeadRecruiters = [];
        teamLeadRecruiters = currentUser.teamMembers.filter(p => p)
        for (let j = 0; j < teamLeadRecruiters.length; j++) {
            for (let i = 0; i < jobs.length; i++) {
                jobCreatedBy = document.createTextNode(jobs[i].createdBy);
                if (jobCreatedBy.nodeValue == teamLeadRecruiters[j]) {
                    noOfJobs++;
                    nameOfRecruiter = jobCreatedBy.nodeValue;
                }
            }

            const tr1 = document.createElement("tr");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            const td3 = document.createElement("td");
            const viewBtn = document.createElement("button")
            viewBtn.setAttribute("id", "viewBtnId")
            viewBtn.setAttribute("onclick", "viewDetails()")
            viewBtn.innerText = "view"
            if (nameOfRecruiter && noOfJobs) {
                td1.append(nameOfRecruiter);
                td2.append(noOfJobs);
                td3.append(viewBtn)
            }
            tr1.appendChild(td1);
            tr1.appendChild(td2);
            tr1.appendChild(td3);

            tablebody.appendChild(tr1);

            noOfJobs = 0;
        }
        table.appendChild(tablebody);
        divJobs.appendChild(table);

    }
    newJobs();

    let divButtons = document.getElementById("divButtons")
    let input = divButtons.querySelectorAll('input')
    input.forEach(e => {
        e.addEventListener("change", function () {
            if (e.id == "todayRadioBtn") {
                document.getElementById('divJobs').innerHTML = "";
                let jobs = JSON.parse(localStorage.getItem('jobs'));
                searchByDate(jobs, new Date());
            }
            if (e.id == "YesterdayRadioBtn") {
                document.getElementById('divJobs').innerHTML = "";
                let jobs = JSON.parse(localStorage.getItem('jobs'));
                searchByDate(jobs, new Date((new Date().setDate((new Date().getDate() - 1)))).toDateString());
            }

        })
    })
    let btnRangeOfDates = document.getElementById("btnRangeOfDatesId")
    btnRangeOfDates.addEventListener("click", () => {
        let dateString1 = document.getElementById('calenderId2').value;
        let dateString2 = document.getElementById('calenderId3').value;
        document.getElementById('divJobs').innerHTML = "";
        let jobs = JSON.parse(localStorage.getItem('jobs'));
        searchByRangeOfDates(jobs, dateString1, dateString2);
    })
    function selectedDate() {
        let selectedDate = document.getElementById('calenderId1')
        let dateString = selectedDate.value
        document.getElementById('divJobs').innerHTML = "";
        let jobs = JSON.parse(localStorage.getItem('jobs'));
        searchByDate(jobs, dateString);
    };
    let dateString;
    function searchByDate(jobs, dateString) {

        var filteredJobs = [];
        let candidatesupdate = false;
        filteredJobs = jobs.filter(job => {
            if (job.candidates) {
                candidatesupdate = job.candidates.some(can => new Date(can.updatedDate).toDateString() == new Date(dateString).toDateString())
            }
            let jobsupdate = new Date(job.updatedDate).toDateString() == new Date(dateString).toDateString()
            if (candidatesupdate || jobsupdate) {
                return job;
            }
        })

        newJobs(filteredJobs);
    }

    function searchByRangeOfDates(jobs, dateString1, dateString2) {

        var jobsCounter = [];

        var jobFilter = jobs.filter(job => {
            let candidateUpdate = false;
            candidateUpdate = job.candidates.some(can => {
                new Date(can.updatedDate).toLocaleDateString() >= new Date(dateString1).toLocaleDateString() && new Date(can.updatedDate).toLocaleDateString() <= new Date(dateString2).toLocaleDateString();
            });
            var jobUpdate =
                new Date(job.updatedDate).toLocaleDateString() >= new Date(dateString1).toLocaleDateString() && new Date(job.updatedDate).toLocaleDateString() <= new Date(dateString2).toLocaleDateString();

            if (jobUpdate || candidateUpdate) {
                let counted = jobsCounter.find(jc => jc.email == job.createdBy)
                if (!counted) {
                    jobsCounter.push({ email: job.createdBy, count: 1 });
                }
                else {
                    counted.count++;
                }
                return job;
            };
        });
        newJobs(jobFilter);

    };


</script>

</html>