<!DOCTYPE html>
<html lang="en">

<head>
    <script type="text/javascript" src="uiHelper.js"></script>
    <script type="text/javascript" src="uiHelper1.js"></script>
    <script type="text/javascript" src="dataEntryHelper.js"></script>
    <script type="text/javascript" src="environmentVariables.js"></script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Recruiters Dairy</title>

    <script>
         (() => {
            const currentUsers = JSON.parse(localStorage.getItem("currentUser"));
            console.log(currentUsers);
            if (currentUsers && currentUsers != null) {
                if (currentUsers.roleId == "1") {
                }
                else {
                    alert("You are not allowed in this page")
                    window.location = 'login.html';
                }
            }
            else {
                alert("You are not allower to view this page")
                window.location = "login.html"
            }
        })();

        function fillJob() {
            var e = getSeedJob();
            var elementfilljobid = document.getElementById('jobId');
            elementfilljobid.setAttribute('disabled', 'disabled');
            elementfilljobid.value = e.jobid;
            var elementfilljobdes = document.getElementById('jobDescription');
            elementfilljobdes.value = e.description;
            e.candidates.forEach(function (candidate) {
                addCandidateForm(candidate);
            });
        }

        function save() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            let date = new Date();
            date= date.toDateString();
            let objectJob = { updatedDate: date };
            const form = document.getElementById("form1");
            const jobId1 = document.getElementById("jobId").value;
            const jobDescription = document.getElementById("jobDescription").value;
            const jobRequirements = document.getElementById("jobRequirements").value;
            const jobLocation = document.getElementById("jobLocation").value;
            const jobPayRange1 = document.getElementById("jobPayRange1").value;
            const jobPayRange2 = document.getElementById("jobPayRange2").value;
            const jobContactPer = document.getElementById("contactPer").value;
            const jobContactPhone = document.getElementById("contactPhone").value;
            // const jobPayPeriod = document.getElementById("payPeriodId").value;
            objectJob.jobid = jobId1;
            objectJob.description = jobDescription;
            objectJob.jobRequirements = jobRequirements;
            objectJob.jobLocation = jobLocation;
            objectJob.jobPayRange1 = jobPayRange1;
            objectJob.jobPayRange2 = jobPayRange2;
            objectJob.jobContactPer = jobContactPer;
            objectJob.jobContactPhone = jobContactPhone;
            // objectJob.jobPayPeriod = jobPayPeriod;
            // console.log(jobPayPeriod);
            const candidates = [];
            const div1 = document.getElementById('divmain');
            div1.querySelectorAll("fieldset").forEach(i => {
                const objectCandidate = { updatedDate: date };
                const e = i.querySelectorAll("div");
                e.forEach(m => {
                    const canInput = m.querySelector('input');
                    if (!canInput) {
                        return;
                    }
                    if (canInput.id.endsWith('name')) {
                        objectCandidate.name = canInput.value;
                    }
                    if (canInput.id.endsWith('phone')) {
                        objectCandidate.phone = canInput.value;
                    }
                    if (canInput.id.endsWith('address')) {
                        objectCandidate.address = canInput.value;
                    }
                    if (canInput.id.endsWith('email')) {
                        objectCandidate.email = canInput.value;
                    }
                });

                objectCandidate.submissionStatusId = Number(i.querySelector('select').value);

                const canText = i.querySelector('textarea').value
                objectCandidate.notes = canText
                candidates.push(objectCandidate)

            });
            objectJob.candidates = candidates;

            let jobs = JSON.parse(localStorage.getItem('jobs'));
            if (!jobs) {
                jobs = [];
            }
            let indexOfJob;
            if (location.search.length > 0) {
                var qureyString = location.search.substring(1);
                console.log(qureyString);
                var jobidSplit = qureyString.split("=");
                var jobidValue = jobidSplit[1];
                if (jobidValue) {
                    indexOfJob = jobs.map((j) => {
                        return j.jobid;
                    }).indexOf(jobidValue);
                }
            }
            if (jobs) {
                if (indexOfJob > -1) {
                    objectJob.createdDate = jobs[indexOfJob].createdDate;
                    objectJob.createdBy = jobs[indexOfJob].createdBy;


                    // candidate if exists will already have createdDate
                    // in that case preserve else set new date
                    // Assumption: the index of candidate in localStorage matches the index of candidate built here
                    for (let index = 0; index < objectJob.candidates.length; index++) {
                        const element = jobs[indexOfJob].candidates[index];
                        if (element) {
                            objectJob.candidates[index].createdDate = element.createdDate;
                            objectJob.candidates[index].createdBy = element.createdBy;

                        } else {
                            objectJob.candidates[index].createdDate = date;
                            objectJob.candidates[index].createdBy = currentUser.email;

                        }
                    }

                    jobs[indexOfJob] = objectJob;

                } else {
                    objectJob = setCreatedDateAndEmail(objectJob, date,currentUser.email);
                    objectJob.createdDate = date;
                    objectJob.createdBy = currentUser.email;
                    objectJob.updatedBy = currentUser.email;
                    jobs.push(objectJob);
                }
            }
            else {
                jobs = [];
                objectJob = setCreatedDateAndEmail(objectJob, date,currentUser.email);
                objectJob.createdDate = date;
                objectJob.createdBy = currentUser.email;
                objectJob.updatedBy = currentUser.email;
                jobs.push(objectJob);
            }

            localStorage.setItem('jobs', JSON.stringify(jobs));
        }
        let divPayPeriod = document.getElementsByClassName('payPeriodClass');
        // divPayPeriod.append(getPayPeriod(candidate.createdDate));
        function setCreatedDateAndEmail(job, date,email) {
            for (let index = 0; index < job.candidates.length; index++) {
                job.candidates[index].createdDate = date;
                job.candidates[index].createdBy = email;

            }
            return job;
        }

        var candidateCounter = 0;

        function addCandidateForm(candidate, i) {
            if (!candidate) {
                candidate = { name: '', address: '', email: '', phone: '', notes: '', submitionStatus: '', createdDate: new Date() };
            }
            candidateCounter++
            const div1 = document.getElementById('divmain');

            var fieldSet = document.createElement('fieldset');
            fieldSet.setAttribute("class", "fieldsetClass")
            var legend = document.createElement('legend');

            var newCandidate = document.createElement('h4');
            newCandidate.innerHTML = `Candidate : ${candidateCounter}`;
            var divCandidate = document.createElement("div");
            divCandidate.setAttribute("id", "divCandidateId")

            var divName = document.createElement('div');
            var newCanNameLabel = document.createElement('label');
            newCanNameLabel.setAttribute("class", "labelclass");
            newCanNameLabel.innerText = "Name  :"
            var newCanNameInput = document.createElement('input');
            newCanNameInput.setAttribute("placeholder", "Enter the Name")
            newCanNameInput.setAttribute("class", "inputClass");
            newCanNameInput.setAttribute("style", "margin-left:35px")
            newCanNameInput.setAttribute("id", "candidate" + `${candidateCounter}` + "name")
            newCanNameInput.value = candidate.name;

            var divAddress = document.createElement('div');
            var newAddressLabel = document.createElement('label');
            newAddressLabel.setAttribute("class", "labelclass");
            newAddressLabel.innerText = "Address   :"
            var newAddressInput = document.createElement('input');
            newAddressInput.setAttribute("placeholder", "Enter the Address")
            newAddressInput.setAttribute("class", "inputClass");
            newAddressInput.setAttribute("type", "address");
            newAddressInput.setAttribute("style", "margin-left:20px");
            newAddressInput.setAttribute("id", "candidate" + `${candidateCounter}` + "address");
            newAddressInput.value = candidate.address;

            var divPhone = document.createElement('div');
            var newCanPhoneLabel = document.createElement('label');
            newCanPhoneLabel.setAttribute("class", "labelclass");
            newCanPhoneLabel.innerText = "PhoneNo   :"
            var newPhoneInput = document.createElement('input');
            newPhoneInput.setAttribute("placeholder", "Enter the Phone Number");
            newPhoneInput.setAttribute("class", "inputClass");
            newPhoneInput.setAttribute("type", "phonenumber");
            newPhoneInput.setAttribute("style", "margin-left:13px")
            newPhoneInput.setAttribute("id", "candidate" + `${candidateCounter}` + "phone")
            newPhoneInput.value = candidate.phone;

            var divEmail = document.createElement('div');
            var newCanEmailLabel = document.createElement('label');
            newCanEmailLabel.setAttribute("class", "labelclass");
            newCanEmailLabel.innerText = "Email  :"
            var newCanEmailInput = document.createElement('input');
            newCanEmailInput.setAttribute("placeholder", "Enter the Email")
            newCanEmailInput.setAttribute("class", "inputClass");
            newCanEmailInput.setAttribute("type", "email");
            newCanEmailInput.setAttribute("style", "margin-left:34px")
            newCanEmailInput.setAttribute("id", "candidate" + `${candidateCounter}` + "email")
            newCanEmailInput.value = candidate.email;

            var divSubmissionStatus = document.createElement('div');
            divSubmissionStatus.setAttribute("id", "divCandidateStatus");
            var newCanSubmissionStatusLbl = document.createElement('label');
            newCanSubmissionStatusLbl.innerText = "Submission Status:";

            var newCanTextareaInput = document.createElement('textarea');
            newCanTextareaInput.setAttribute("placeholder", "Enter the Notes");
            newCanTextareaInput.innerText = "Add Notes";
            newCanTextareaInput.setAttribute("cols", "32");
            newCanTextareaInput.value = candidate.notes;

            if (candidateCounter > 0 && candidate.name != "") {
                var divDate = document.createElement('div');
                var newCanDateLabelCreated = document.createElement('label');
                var newCanDateLabel = document.createElement('label');
                newCanDateLabelCreated.innerText = "Last Updated Date: ";
                const updatedDateDisplay = `${new Date(candidate.updatedDate).toDateString()} ${new Date(candidate.updatedDate).toLocaleTimeString()}`;
                newCanDateLabel.innerText = updatedDateDisplay;
            }

            var divCanDelete = document.createElement('div');
            divCanDelete.setAttribute("id", "divCanDelete");
            var newCanDeleteBtn = document.createElement('button');
            newCanDeleteBtn.setAttribute("type", "button");
            newCanDeleteBtn.setAttribute("class", "editBtnClass");
            newCanDeleteBtn.innerText = "Delete";
            const canIndex = candidateCounter - 1;
            newCanDeleteBtn.addEventListener("click", function () {
                if (confirm("Are you sure to Delete a Candidate " + `${candidate.name}` + " ?")) {
                    var jobs = JSON.parse(localStorage.getItem('jobs'));
                    jobs[i].candidates.splice(canIndex, 1);
                    localStorage.setItem("jobs", JSON.stringify(jobs));
                    load();
                }
            });

            div1.append(fieldSet);
            fieldSet.append(legend);
            fieldSet.append(divCandidate);
            legend.append(newCandidate)

            
            if (candidateCounter > 0 && candidate.name != "") {
                divCandidate.append(divDate);
                divDate.append(newCanDateLabelCreated);
                divDate.append(newCanDateLabel);
            }

            divCandidate.append(divName);
            divName.append(newCanNameLabel);
            divName.append(newCanNameInput);


            divCandidate.append(divAddress);
            divAddress.append(newAddressLabel);
            divAddress.append(newAddressInput);

            divCandidate.append(divPhone)
            divPhone.append(newCanPhoneLabel);
            divPhone.append(newPhoneInput);

            divCandidate.append(divEmail)
            divEmail.append(newCanEmailLabel);
            divEmail.append(newCanEmailInput);

            divCandidate.append(newCanTextareaInput);
            divCandidate.append(divSubmissionStatus);
            divSubmissionStatus.append(newCanSubmissionStatusLbl);
            divSubmissionStatus.append(getSubmissionStatusSelect(candidate.submissionStatusId, "candidate" + `${candidateCounter}` + "submissionStatus"));

            divCandidate.append(divCanDelete);
            divCanDelete.append(newCanDeleteBtn);

        }
    </script>
</head>

<body>
    <h1 class="banner">Recruiters Dairy</h1>
    <hr>

    <button id="fillJob" onclick="fillJob()" type="button">Fill</button>


    <form action="" id="form1" style="margin-top: 25px;">
        <div id="divForm">
            <label id="jobIdLbl" for=" jobId">Job Id</label>
            <input class="inputClass" id="jobId" type="number" placeholder="Endter Id">
            <label for="jobDescription">Job Description</label>
            <textarea class="inputClass name="" id="jobDescription" cols="21" rows="1" placeholder="Enter Description"></textarea>
            <label for="jobRequirements">Job Requirements</label>
            <textarea class="inputClass" name="" id="jobRequirements" cols="21" rows="1" placeholder="Enter Requirements"></textarea>
            <label for="jobLocation">Job Location</label>
            <input id="jobLocation" type="text" required class="inputClass" placeholder="Enter Location">
            <label for="jobPayRange">Job PayRange</label>
            <input id="jobPayRange1" type="text" required class="inputClass" placeholder="Enter PayRange">
            <p style="margin-bottom: 0px;">to</p>
            <input id="jobPayRange2" type="text" required class="inputClass" placeholder="Enter PayRange">
            <label for="">Contact Person</label>
            <input id="contactPer" type="text" class="inputClass" placeholder="Enter ContactPerson">
            <label for="">Contact Phone </label>
            <input id="contactPhone" type="number" class="inputClass" placeholder="Enter ContactPhone">
            <label for="" id="payPeriodLbl">PayPeriod</label>
            <br>
            <div id="divSearchBtn">
                <button class="buttonClass" id="btnSearch" type="button" onclick="load()">Search</button>
                <input class="inputClass" id="searchText" type="text">
            </div>
        </div>
    </form>
    <br>
    <button class="buttonClass" onclick="addCandidateForm()" type="button">Add new candidate</button>
    <div id="divmain"></div>
    <br>
    <button class="buttonClass" id="savebutton" type="button" onclick="save()">Save</button>



</body>

<script>
    function load() {
        candidateCounter = 0;
        if (init.environment !== 'development') {
            document.getElementById('fillJob').setAttribute("style", "display:none");
        }
        document.getElementById("divmain").innerHTML = "";

        if (location.search.length > 0) {
            var qureyString = location.search.substring(1);
            var jobidSplit = qureyString.split("=");
            var jobidValue = jobidSplit[1];
        }

        if (jobidValue != 0 && jobidValue != null) {

            var jobs = JSON.parse(localStorage.getItem('jobs'));

            if (!jobs) {
                jobs = [];
            }
            jobs.forEach((e, i) => {
                if (e.jobid == jobidValue) {
                    var elementfilljobid = document.getElementById('jobId');
                    elementfilljobid.setAttribute('disabled', 'disabled');
                    elementfilljobid.value = e.jobid
                    var elementfilljobdes = document.getElementById('jobDescription')
                    elementfilljobdes.value = e.description
                    var elementfilljobReq = document.getElementById('jobRequirements')
                    elementfilljobReq.value = e.jobRequirements
                    var elementfilljobLoc = document.getElementById('jobLocation')
                    elementfilljobLoc.value = e.jobLocation
                    var elementfilljobPay1 = document.getElementById('jobPayRange1')
                    elementfilljobPay1.value = e.jobPayRange1
                    var elementfilljobPay2 = document.getElementById('jobPayRange2')
                    elementfilljobPay2.value = e.jobPayRange2
                    var elementfillContactPerson = document.getElementById("contactPer")
                    elementfillContactPerson.value = e.jobContactPer
                    var elementfillContactPhone = document.getElementById("contactPhone")
                    elementfillContactPhone.value = e.jobContactPhone
                    var elementfillContactPayPeriod = document.getElementById("payPeriod");
                    // elementfillContactPayPeriod.value = e.jobPayPeriod;

                    const elementSearchValue = document.getElementById('searchText').value.toLowerCase();
                    const filterCandidates = e.candidates.filter
                        (c => c.address.toLowerCase().indexOf(elementSearchValue) > -1 || c.name.toLowerCase().indexOf(elementSearchValue) > -1 || c.phone.indexOf(elementSearchValue) > -1 || c.email.indexOf(elementSearchValue) > -1 || c.notes.indexOf(elementSearchValue) > -1 || c.submissionStatus.indexOf(elementSearchValue) > -1);

                    filterCandidates.forEach(function (candidate) {
                        addCandidateForm(candidate, i);
                    });
                    return;
                }
            })
        }
        else {
            document.getElementById("btnSearch").setAttribute("style", "display:none");
            document.getElementById("searchText").setAttribute("style", "display:none");
        }

    }
    load();
</script>


</html>