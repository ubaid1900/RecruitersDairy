<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="uiHelper.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <script type="text/javascript" src="crudLocalStorage.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css"
        integrity="sha512-KXol4x3sVoO+8ZsWPFI/r5KBVB/ssCGB5tsv2nVOKwLg33wTFP3fmnXa47FdSVIshVTgsYk/1734xSk9aFIa4A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">

    <title>Recruiters Dairy</title>
</head>

<body>
    <h1 class="banner">Recruiters Dairy</h1>
    <div id="divLogOut">
        <div>
            <button class="ui blue button" onclick="window.location='login.html'">Log Out</button>
        </div>
        &nbsp;&nbsp;&nbsp;
        <div style="display: inline; font-size: large;" id="userNameDiv"></div>
    </div>
    <hr>
    <div id="divRadio" class="ui input focus">
        <input id="inputToday" type="radio" value="today" name="datesGroup">:Today
        <input id="inputYesterday" type="radio" value="Yesterday" name="datesGroup">:Yesterday
    </div>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <div class="ui input focus">
        <input id="selectedDateId" type="date" onchange="searchBySelectedDate()">
    </div>
    <br><br>
    <div class="ui input focus">
        <input type="date" id="calenderId2">
        <input type="date" id="calenderId3">
        <button id="btnRangeOfDatesId" class="ui button blue">Range Of Date</button>
    </div>
    <br>
    <br>
    <div id="divTable"></div>
    <div>
        <canvas id="myChart"></canvas>
        <canvas id="recruitersChart"></canvas>
    </div>
</body>
<script>
    (() => {
        const currentUser = getCurrentUser();
        const userNameDiv = document.getElementById("userNameDiv");
        userNameDiv.innerHTML = currentUser.email;


        if (currentUser && currentUser != null) {
            if (currentUser.roleId == 3) {

            }
            else {
                alert("You are not allowed in this page");
                window.location = "logIn.html";
            }
        }
        else {
            alert("You are not allowed in this page");
            window.location = "logIn.html";
        }

    })();

    function newJobs(jobs) {
        let divJobs = document.getElementById('divTable');
        if (!jobs || !jobs.length) {
            const divResult = document.createElement("div");
            divResult.innerText = "NO Results Found";
            divJobs.appendChild(divResult);
            return;
        }

        const table = document.createElement("table");
        const currentUser1 = getCurrentUser();

        const th1 = document.createElement("th");
        th1.innerText = "Name of the TeamLeader";

        const th2 = document.createElement("th");
        th2.innerText = "No of Jobs";

        const th3 = document.createElement("th");
        th3.innerText = "view";

        const tr = document.createElement("tr");


        const divTable = document.getElementById("divTable");
        table.setAttribute("class", "ui celled table");

        divTable.setAttribute("style", "boder:2px")
        divTable.append(table);
        table.append(tr);

        tr.append(th1);
        tr.append(th2);
        tr.append(th3);
        const currentUser = getCurrentUser();

        let count = 0;
        for (let j = 0; j < currentUser.teamMembers.length; j++) {
            let jobsFilter;
            let users = getSeedUsers();

            jobsFilter = jobs.filter(job => {
                let filterdUser = users.filter(i => {
                    if (i.email == currentUser.teamMembers[j]) {
                        return i
                    }

                })
                if (filterdUser[0].teamMembers.includes(job.createdBy)) {
                    count++;
                    return job;

                }
            })

            const tr1 = document.createElement("tr");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            const td3 = document.createElement("td");
            const viewBtn = document.createElement("button");
            viewBtn.setAttribute("type", "button");
            viewBtn.setAttribute("class", "ui button blue")
            viewBtn.innerText = "view"

            td1.innerText = currentUser.teamMembers[j];
            td2.innerText = count;
            td3.innerText = viewBtn.innerText;

            tr1.append(td1);
            tr1.append(td2);
            tr1.append(td3);

            table.append(tr1);
            count = 0;

        }

    }
    newJobs(getJobs());


    function lookupByStatus(jobs) {

        let currentUser = getCurrentUser();
        const statuses = getSubmissionStatuses();
        const jobsCounter = [];
        let filterJobs = [];
        let filterdUser;
        let users = getSeedUsers();
        for (let i = 0; i < currentUser.teamMembers.length; i++) {

            filterJobs = jobs.filter(j => {
                currentUser.teamMembers[i]
                filterdUser = users.filter(k => {
                    if (k.email == currentUser.teamMembers[i]) {
                        return k;
                    }
                });

                for (let m = 0; m < filterdUser.length; m++) {
                    if (filterdUser[m].teamMembers[m].includes(j.updatedBy) ||
                        j.candidates.some(c => filterdUser[m].teamMembers[m].includes(j.updatedBy))) {
                        return j
                    }
                }

            })


            filterJobs.forEach(job => {
                job.candidates?.forEach(c => {
                    const counted = jobsCounter.find(jc =>
                        jc?.email == job.updatedBy
                        &&
                        jc?.statusId == c.submissionStatusId

                    );
                    if (!counted) {
                        jobsCounter.push({
                            email: job.updatedBy,
                            statusId: c.submissionStatusId,
                            status: statuses.find(s => s.id == c.submissionStatusId).text,
                            count: 1
                        });
                    }
                    else {
                        counted.count++
                    }

                });
            });
        }
        return jobsCounter;

    };

    function loadJobsByStatus(jobsByStatus) {
        if (!jobsByStatus) {
            console.error('input was null!');
            return;
        }
        let currentUser = getCurrentUser();
        let users = getSeedUsers();
        let filterdUsers = [];
        let filterdUser;
        for (let i = 0; i < currentUser.teamMembers.length; i++) {
            filterdUser = users.filter(k =>
                (k.email == currentUser.teamMembers[i])
            );
            filterdUsers.push(filterdUser);
        }
        const tableElement = document.createElement('table');
        tableElement.setAttribute("class", "ui celled table");

        jobsByStatus.forEach(j => {
            const trElement = document.createElement('tr');
            const tdEmail = document.createElement('td');

            for (let i = 0; i < filterdUsers.length - 1; i++) {
                for (let k = 0; k < filterdUsers.length; k++) {
                    if (j.email == filterdUsers[k][i].teamMembers[i]) {
                        tdEmail.innerText = filterdUsers[k][i].email;
                    }
                }
            }
            trElement.append(tdEmail);

            const tdCount = document.createElement('td');
            tdCount.innerText = j.count;
            trElement.append(tdCount);

            const tdStatus = document.createElement('td');
            tdStatus.innerText = j.status;
            trElement.append(tdStatus);

            tableElement.append(trElement);
        });
        const divTable = document.getElementById('divTable');
        divTable.append(document.createElement('hr'));
        divTable.append(tableElement);
    }

    const jobsByStatus = lookupByStatus(getJobs());

    loadJobsByStatus(jobsByStatus);


    const divRadio = document.getElementById("divRadio")
    const input = divRadio.querySelectorAll("input");
    input.forEach(e => {
        e.addEventListener("change", function () {
            document.getElementById("divTable").innerHTML = "";
            if (e.id == "inputToday") {
                document.getElementById("inputToday").innerHTML = "";
                document.getElementById('recruitersChart').innerHTML = "";
                const jobs = getJobs();
                searchByDate(jobs, new Date());
            }
            if (e.id == "inputYesterday") {
                document.getElementById("inputToday").innerHTML = "";
                const jobs = getJobs();
                if (new Date().getDate() == 1) {
                    searchByDate(jobs, new Date(new Date().setMonth(new Date().getMonth() - 1, 0)))
                }
                else {
                    searchByDate(jobs, new Date(new Date().setDate(new Date().getDate() - 1)));
                }
            }
        })
    });

    let btnRangeOfDates = document.getElementById("btnRangeOfDatesId")
    btnRangeOfDates.addEventListener("click", () => {
        let dateString1 = document.getElementById('calenderId2').value;
        let dateString2 = document.getElementById('calenderId3').value;
        document.getElementById('divTable').innerHTML = "";
        let jobs = getJobs();
        searchByRangeOfDates(jobs, dateString1, dateString2);
    })


    function searchByDate(jobs, dateString) {

        let filteredJobs = [];
        let canUpdated = false;
        filteredJobs = jobs.filter(job => {
            if (job.candidates) {
                canUpdated = job.candidates.some(can => {
                    if (new Date(can.updatedDate).toLocaleDateString() == new Date(dateString).toLocaleDateString()) {
                        return can
                    }

                })

                let jobsUpdateBy = new Date(job.updatedDate).toDateString() == new Date(dateString).toDateString()
                if (canUpdated || jobsUpdateBy) {
                    return job;
                }
            }
        })
        newJobs(filteredJobs);

    }

    function searchBySelectedDate() {
        const jobs = getJobs();
        const selectedDate = document.getElementById("selectedDateId");
        const dateString = selectedDate.value;
        document.getElementById("divTable").innerHTML = "";
        searchByDate(jobs, dateString);
    }

    function searchByRangeOfDates(jobs, dateString1, dateString2) {

        var jobsCounter = [];

        var jobFilter = jobs.filter(job => {
            let candidateUpdate = false;
            candidateUpdate = job.candidates.some(can => {
                new Date(can.updatedDate).toLocaleDateString() >= new Date(dateString1).toLocaleDateString() && new Date(can.updatedDate).toLocaleDateString() <= new Date(dateString2).toLocaleDateString();
            });
            var jobUpdate =
                new Date(job.updatedDate).toLocaleDateString() >= new Date(dateString1).toLocaleDateString() && new Date(job.updatedDate).toLocaleDateString() <= new Date(dateString2).toLocaleDateString();

            if (jobUpdate || candidateUpdate) {
                let counted = jobsCounter.find(jc => jc.email == job.createdBy)
                if (!counted) {
                    jobsCounter.push({ email: job.createdBy, count: 1 });
                }
                else {
                    counted.count++;
                }
                return job;
            };
        });
        newJobs(jobFilter);

    };
    function chartJobsByStatus(jobsByStatus) {
        const recruitersCtx = document.getElementById('recruitersChart');
        let currentUser = getCurrentUser();
        let users = getSeedUsers();
        let filterdUsers = [];
        let filterdUser;
        for (let i = 0; i < currentUser.teamMembers.length; i++) {
            filterdUser = users.filter(k =>
                (k.email == currentUser.teamMembers[i])
            );
            filterdUsers.push(filterdUser);
        }
        jobsByStatus.map(j => {

            for (let i = 0; i < filterdUsers.length - 1; i++) {
                for (let k = 0; k < filterdUsers.length; k++) {
                    if (j.email == filterdUsers[k][i].teamMembers[i]) {
                        j.email = filterdUsers[k][i].email;

                    }
                }
            }
        });
        new Chart(recruitersCtx, {
            type: 'bar',
            data: {
                labels: jobsByStatus.map(j => j.email + '-' + j.status),
                datasets: [{
                    label: 'Recruiters by candidate status',
                    data: jobsByStatus.map(j => j.count),
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    chartJobsByStatus(jobsByStatus);


</script>

</html>